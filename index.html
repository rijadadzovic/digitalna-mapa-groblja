<script>
  (function () {
    // DOM elementi
    const userModeBtn = document.getElementById('userModeBtn');
    const adminModeBtn = document.getElementById('adminModeBtn');
    const modeInfo = document.getElementById('modeInfo');

    const nameInput = document.getElementById('name');
    const dateFromInput = document.getElementById('dateFrom');
    const dateToInput = document.getElementById('dateTo');
    const searchBtn = document.getElementById('searchBtn');
    const summaryText = document.getElementById('summaryText');
    const resultsBody = document.getElementById('resultsBody');

    const formAddWrapper = document.getElementById('formAddWrapper');
    const editModeLabel = document.getElementById('editModeLabel');
    const addFirstName = document.getElementById('addFirstName');
    const addLastName = document.getElementById('addLastName');
    const addDob = document.getElementById('addDob');
    const addDod = document.getElementById('addDod');
    const addSection = document.getElementById('addSection');
    const addRow = document.getElementById('addRow');
    const addPlot = document.getElementById('addPlot');
    const addBtn = document.getElementById('addBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const addStatus = document.getElementById('addStatus');

    const adminMapPanel = document.getElementById('adminMapPanel');
    const mapFileInput = document.getElementById('mapFile');
    const uploadMapBtn = document.getElementById('uploadMapBtn');
    const clearMapImgBtn = document.getElementById('clearMapImg');

    const mapGridWrapper = document.getElementById('mapGridWrapper');
    const mapInner = document.getElementById('mapInner');
    const mapImage = document.getElementById('mapImage');
    const zoomInBtn = document.getElementById('zoomInBtn');
    const zoomOutBtn = document.getElementById('zoomOutBtn');

    const MAP_STORAGE_KEY = 'digitalnaMapa_groblje_data';
    const MAP_IMAGE_KEY = 'digitalnaMapa_groblje_image';
    const defaultMapSrc = mapImage.getAttribute('src') || '';

    let mode = 'user';
    let adminUnlocked = false; // za lozinku
    let graves = [];
    let filteredGraves = [];
    let selectedId = null;
    let editingId = null;
    let markerEl = null;

    let zoomLevel = 1;
    const MIN_ZOOM = 0.6;
    const MAX_ZOOM = 2.0;
    const ZOOM_STEP = 0.2;

    // --- Pomoćne funkcije za podatke ---
    function loadData() {
      try {
        const raw = localStorage.getItem(MAP_STORAGE_KEY);
        graves = raw ? JSON.parse(raw) : [];
      } catch (e) {
        graves = [];
      }
      filteredGraves = graves.slice();
    }

    function saveData() {
      localStorage.setItem(MAP_STORAGE_KEY, JSON.stringify(graves));
    }

    function loadMapImage() {
      const stored = localStorage.getItem(MAP_IMAGE_KEY);
      if (stored) {
        mapImage.src = stored;
      }
    }

    function applyZoom() {
      mapInner.style.transform = 'scale(' + zoomLevel + ')';
      mapInner.style.transformOrigin = 'top left';
    }

    // --- Prebacivanje moda (uz lozinku za admin dio) ---
    function setMode(newMode) {
      // jednostavna lozinka – više da spriječi slučajno “čačkanje”
      if (newMode === 'admin' && !adminUnlocked) {
        const pwd = prompt('Unesite lozinku za administratorski dio:');
        // OVDJE PROMIJENI LOZINKU PO ŽELJI:
        if (pwd !== '1234') {
          alert('Pogrešna lozinka.');
          return;
        }
        adminUnlocked = true;
      }

      mode = newMode;

      if (mode === 'user') {
        userModeBtn.classList.add('active');
        adminModeBtn.classList.remove('active');
        formAddWrapper.style.display = 'none';
        modeInfo.innerHTML =
          'Trenutno ste u <strong>korisničkom prikazu</strong> – možete pretraživati i gledati lokacije, ali ne možete mijenjati podatke.';
      } else {
        adminModeBtn.classList.add('active');
        userModeBtn.classList.remove('active');
        formAddWrapper.style.display = 'block';
        modeInfo.innerHTML =
          'Trenutno ste u <strong>administratorskom prikazu</strong> – možete dodavati, uređivati i brisati zapise, te postavljati lokacije na mapi.';
      }

      renderResults();
    }

    // --- Marker i centriranje ---
    function clearMarker() {
      if (markerEl) {
        markerEl.remove();
        markerEl = null;
      }
    }

    function ensureMarker() {
      if (!markerEl) {
        markerEl = document.createElement('div');
        markerEl.className = 'marker';
        mapInner.appendChild(markerEl);
      }
    }

    function centerOnMarker() {
      if (!markerEl) return;
      const wrapperRect = mapGridWrapper.getBoundingClientRect();
      const markerRect = markerEl.getBoundingClientRect();

      const offsetX =
        markerRect.left + markerRect.width / 2 - (wrapperRect.left + wrapperRect.width / 2);
      const offsetY =
        markerRect.top + markerRect.height / 2 - (wrapperRect.top + wrapperRect.height / 2);

      mapGridWrapper.scrollLeft += offsetX;
      mapGridWrapper.scrollTop += offsetY;
    }

    function showMarker(grave) {
      if (!grave || typeof grave.x !== 'number' || typeof grave.y !== 'number') {
        clearMarker();
        return;
      }
      ensureMarker();
      markerEl.style.left = grave.x + '%';
      markerEl.style.top = grave.y + '%';
      centerOnMarker();
    }

    // --- Formatiranje teksta u tabeli ---
    function formatYears(dob, dod) {
      if (!dob && !dod) return '';
      const dobY = dob ? dob.slice(0, 4) : '';
      const dodY = dod ? dod.slice(0, 4) : '';
      if (dobY && dodY) return dobY + '–' + dodY;
      return dobY || dodY;
    }

    function formatParcel(g) {
      const parts = [];
      if (g.section) parts.push(g.section);
      if (g.row) parts.push('red ' + g.row);
      if (g.plot) parts.push('grob ' + g.plot);
      return parts.join(' / ');
    }

    // --- Filteri za pretragu ---
    function applyFilters() {
      let list = graves.slice();
      const nameQuery = nameInput.value.trim().toLowerCase();
      const from = dateFromInput.value;
      const to = dateToInput.value;

      if (nameQuery) {
        list = list.filter((g) => {
          const fullName = ((g.firstName || '') + ' ' + (g.lastName || '')).toLowerCase();
          return fullName.includes(nameQuery);
        });
      }

      if (from) {
        list = list.filter((g) => !g.dod || g.dod >= from);
      }
      if (to) {
        list = list.filter((g) => !g.dod || g.dod <= to);
      }

      filteredGraves = list;
      renderResults();
    }

    // --- Forma za dodavanje / uređivanje ---
    function resetForm() {
      editingId = null;
      addFirstName.value = '';
      addLastName.value = '';
      addDob.value = '';
      addDod.value = '';
      addSection.value = '';
      addRow.value = '';
      addPlot.value = '';
      addStatus.textContent = '';
      addStatus.classList.remove('error');
      editModeLabel.style.display = 'none';
      cancelEditBtn.style.display = 'none';
      formAddWrapper.classList.remove('mode-edit');
    }

    function startEdit(grave) {
      editingId = grave.id;
      addFirstName.value = grave.firstName || '';
      addLastName.value = grave.lastName || '';
      addDob.value = grave.dob || '';
      addDod.value = grave.dod || '';
      addSection.value = grave.section || '';
      addRow.value = grave.row != null ? grave.row : '';
      addPlot.value = grave.plot != null ? grave.plot : '';
      editModeLabel.style.display = 'block';
      cancelEditBtn.style.display = 'inline-block';
      formAddWrapper.classList.add('mode-edit');
      addStatus.textContent = 'Uređujete zapis – kliknite na mapu da postavite ili promijenite lokaciju.';
      addStatus.classList.remove('error');
    }

    // --- Iscrtavanje tabele / rezultata ---
    function renderResults() {
      resultsBody.innerHTML = '';

      if (!graves.length) {
        summaryText.textContent =
          mode === 'admin'
            ? 'Još uvijek nema unesenih zapisa. Dodajte prvi zapis u formi ispod.'
            : 'Još uvijek nema dostupnih podataka.';
        clearMarker();
        return;
      }

      const list = filteredGraves && filteredGraves.length ? filteredGraves : [];

      if (!list.length) {
        summaryText.textContent = 'Nema rezultata za zadane filtere.';
        clearMarker();
        return;
      }

      summaryText.textContent = 'Pronađeno zapisa: ' + list.length;

      list.forEach((g) => {
        const tr = document.createElement('tr');
        if (g.id === selectedId) {
          tr.classList.add('selected');
        }

        const tdName = document.createElement('td');
        tdName.textContent = (g.firstName || '') + ' ' + (g.lastName || '');

        const tdYears = document.createElement('td');
        tdYears.textContent = formatYears(g.dob, g.dod);

        const tdParcel = document.createElement('td');
        tdParcel.textContent = formatParcel(g);

        const tdActions = document.createElement('td');
        tdActions.className = 'actions-cell';

        if (mode === 'admin') {
          const editBtnEl = document.createElement('button');
          editBtnEl.textContent = 'Uredi';
          editBtnEl.className = 'small';
          editBtnEl.addEventListener('click', function (ev) {
            ev.stopPropagation();
            startEdit(g);
          });

          const delBtnEl = document.createElement('button');
          delBtnEl.textContent = 'Obriši';
          delBtnEl.className = 'small danger';
          delBtnEl.addEventListener('click', function (ev) {
            ev.stopPropagation();
            if (confirm('Da li sigurno želite obrisati ovaj zapis?')) {
              graves = graves.filter((x) => x.id !== g.id);
              if (selectedId === g.id) selectedId = null;
              if (editingId === g.id) resetForm();
              saveData();
              applyFilters();
            }
          });

          tdActions.appendChild(editBtnEl);
          tdActions.appendChild(delBtnEl);
        } else {
          tdActions.textContent = '';
        }

        tr.appendChild(tdName);
        tr.appendChild(tdYears);
        tr.appendChild(tdParcel);
        tr.appendChild(tdActions);

        // Klik na red – isti u admin i user modu
        tr.addEventListener('click', function () {
          selectedId = g.id;
          showMarker(g);      // ista pozicija u oba moda
          centerOnMarker();
          renderResults();
        });

        resultsBody.appendChild(tr);
      });

      const selected = graves.find((g) => g.id === selectedId);
      if (selected) {
        showMarker(selected);
      }
    }

    // --- Eventi za modove ---
    userModeBtn.addEventListener('click', function () {
      setMode('user');
    });
    adminModeBtn.addEventListener('click', function () {
      setMode('admin');
    });

    // --- Pretraga ---
    searchBtn.addEventListener('click', function () {
      applyFilters();
    });
    nameInput.addEventListener('keyup', function (e) {
      if (e.key === 'Enter') applyFilters();
    });

    // --- Dodavanje / uređivanje zapisa ---
    addBtn.addEventListener('click', function (e) {
      e.preventDefault();

      const firstName = addFirstName.value.trim();
      const lastName = addLastName.value.trim();
      const dob = addDob.value || '';
      const dod = addDod.value || '';
      const section = addSection.value.trim();
      const row = addRow.value ? parseInt(addRow.value, 10) : null;
      const plot = addPlot.value ? parseInt(addPlot.value, 10) : null;

      if (!firstName || !lastName) {
        addStatus.textContent = 'Ime i prezime su obavezni.';
        addStatus.classList.add('error');
        return;
      }

      let grave;

      if (editingId) {
        // ažuriranje postojećeg
        grave = graves.find((g) => g.id === editingId);
        if (!grave) {
          addStatus.textContent = 'Greška: zapis nije pronađen.';
          addStatus.classList.add('error');
          return;
        }
        grave.firstName = firstName;
        grave.lastName = lastName;
        grave.dob = dob;
        grave.dod = dod;
        grave.section = section;
        grave.row = row;
        grave.plot = plot;
        addStatus.textContent =
          'Zapis je ažuriran. Po potrebi kliknite na mapu da promijenite lokaciju groba.';
        addStatus.classList.remove('error');
      } else {
        // NOVI ZAPIS – odmah ga stavljamo u režim uređivanja
        grave = {
          id: Date.now(),
          firstName,
          lastName,
          dob,
          dod,
          section,
          row,
          plot,
          x: null,
          y: null
        };
        graves.push(grave);
        selectedId = grave.id;
        startEdit(grave); // odmah u "uređivanje", da možeš kliknuti na mapu
        addStatus.textContent =
          'Novi zapis je sačuvan. Sada kliknite na mapu da postavite lokaciju groba.';
        addStatus.classList.remove('error');
      }

      saveData();
      applyFilters();
      // ne resetujemo formu automatski – ostaje u režimu uređivanja
    });

    cancelEditBtn.addEventListener('click', function () {
      resetForm();
    });

    // --- Klik na mapu u admin modu: postavljanje lokacije ---
    mapInner.addEventListener('click', function (e) {
      if (mode !== 'admin') {
        return;
      }

      const targetId = editingId || selectedId;
      if (!targetId) {
        alert('Prvo odaberite zapis u tabeli ili ga otvorite za uređivanje.');
        return;
      }

      const rect = mapInner.getBoundingClientRect();
      const xPercent = ((e.clientX - rect.left) / rect.width) * 100;
      const yPercent = ((e.clientY - rect.top) / rect.height) * 100;

      const grave = graves.find((g) => g.id === targetId);
      if (!grave) return;

      grave.x = xPercent;
      grave.y = yPercent;

      saveData();
      addStatus.textContent = 'Lokacija groba je spašena. Biće ista u admin i korisničkom prikazu.';
      addStatus.classList.remove('error');
      showMarker(grave);
      applyFilters();
    });

    // --- Učitavanje slike mape ---
    uploadMapBtn.addEventListener('click', function () {
      const file = mapFileInput.files && mapFileInput.files[0];
      if (!file) {
        alert('Molimo odaberite sliku mape.');
        return;
      }
      const reader = new FileReader();
      reader.onload = function (evt) {
        const dataUrl = evt.target.result;
        mapImage.src = dataUrl;
        localStorage.setItem(MAP_IMAGE_KEY, dataUrl);
      };
      reader.readAsDataURL(file);
    });

    clearMapImgBtn.addEventListener('click', function () {
      localStorage.removeItem(MAP_IMAGE_KEY);
      mapImage.src = defaultMapSrc || '';
    });

    // --- Zumiranje ---
    zoomInBtn.addEventListener('click', function () {
      zoomLevel = Math.min(MAX_ZOOM, zoomLevel + ZOOM_STEP);
      applyZoom();
    });

    zoomOutBtn.addEventListener('click', function () {
      zoomLevel = Math.max(MIN_ZOOM, zoomLevel - ZOOM_STEP);
      applyZoom();
    });

    // --- Inicijalizacija ---
    loadData();
    loadMapImage();
    applyZoom();
    setMode('user');
    applyFilters();
  })();
</script>
