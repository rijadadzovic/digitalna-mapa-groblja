<!DOCTYPE html>
<html lang="bs">
<head>
  <meta charset="UTF-8" />
  <title>Digitalna mapa groblja – korisnici i administratori</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 16px;
      background: #f3f4f6;
    }
    h1 {
      margin-top: 0;
    }
    .app {
      max-width: 1400px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 16px 16px 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }
    .title-wrap {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .subtitle {
      font-size: 12px;
      color: #4b5563;
    }
    .mode-switch {
      display: inline-flex;
      border-radius: 999px;
      background: #e5e7eb;
      padding: 2px;
      align-items: center;
      gap: 2px;
    }
    .mode-btn {
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      background: transparent;
      color: #4b5563;
      transition: background 0.15s, color 0.15s;
      white-space: nowrap;
    }
    .mode-btn.active {
      background: #2563eb;
      color: #ffffff;
    }
    .mode-info {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 12px;
    }
    .layout {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 16px;
      min-height: 70vh;
    }
    @media (max-width: 960px) {
      .layout {
        grid-template-columns: 1fr;
      }
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
      }
    }
    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin: 8px 0 4px 0;
      color: #111827;
    }
    .map-author {
      font-size: 11px;
      color: #4b5563;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
      align-items: flex-end;
    }
    .field {
      display: flex;
      flex-direction: column;
      min-width: 150px;
      flex: 1;
    }
    label {
      font-size: 12px;
      margin-bottom: 4px;
      color: #374151;
    }
    input, select {
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
    }
    button {
      padding: 9px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      background: #2563eb;
      color: white;
      transition: transform 0.05s ease, box-shadow 0.05s ease, opacity 0.15s;
      white-space: nowrap;
    }
    button.secondary {
      background: #6b7280;
    }
    button.danger {
      background: #dc2626;
    }
    button.small {
      padding: 6px 10px;
      font-size: 12px;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 12px rgba(37,99,235,0.35);
      opacity: 0.95;
    }
    button:active {
      transform: translateY(0);
      box-shadow: none;
    }
    .results-wrapper {
      max-height: 260px;
      overflow: auto;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      text-align: left;
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
    }
    th {
      background: #f9fafb;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr {
      cursor: pointer;
    }
    tbody tr:hover {
      background: #eff6ff;
    }
    tbody tr.selected {
      background: #dbeafe;
    }
    .actions-cell button {
      margin-right: 4px;
    }

    .map-toolbar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
      font-size: 11px;
      color: #4b5563;
    }
    .map-zoom-btn {
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      box-shadow: 0 1px 2px rgba(15,23,42,0.06);
    }
    .map-zoom-btn:active {
      transform: scale(0.97);
    }
    .summary {
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 6px;
    }
    .map-card {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 10px;
      background: #f9fafb;
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: 100%;
    }
    .map-grid-wrapper {
      position: relative;
      width: 100%;
      flex: 1;
      border-radius: 10px;
      overflow: auto;
      touch-action: pan-x pan-y;
      background: repeating-linear-gradient(
        to right,
        #e5e7eb 0,
        #e5e7eb 1px,
        transparent 1px,
        transparent calc(100%/12)
      ),
      repeating-linear-gradient(
        to bottom,
        #e5e7eb 0,
        #e5e7eb 1px,
        transparent 1px,
        transparent calc(100%/12)
      );
    }
    .map-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transform-origin: 0 0;
    }
    #mapImage {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .marker {
      position: absolute;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #dc2626;
      border: 2px solid #ffffff;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 0 3px rgba(220,38,38,0.35);
    }
    .marker.selected {
      background: #2563eb;
      box-shadow: 0 0 0 3px rgba(37,99,235,0.35);
    }
    .legend {
      font-size: 11px;
      color: #6b7280;
    }
    .pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 11px;
      color: #374151;
    }

    .form-add {
      margin-top: 12px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      padding: 10px;
      background: #f9fafb;
    }
    .form-add-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }
    .status {
      font-size: 11px;
      color: #059669;
      min-height: 14px;
    }
    .status.error {
      color: #dc2626;
    }
    .mode-edit-label {
      font-size: 11px;
      color: #1d4ed8;
      margin-bottom: 4px;
    }
    .admin-badge {
      font-size: 11px;
      color: #16a34a;
      margin-left: 4px;
    }
    .admin-map-panel {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px dashed #d1d5db;
      font-size: 11px;
      color: #374151;
    }
    .admin-map-panel label {
      font-size: 11px;
      margin-bottom: 2px;
    }

    .donor-banner {
      margin-top: 8px;
      border-radius: 0 0 12px 12px;
      background: linear-gradient(90deg, #111827, #1d4ed8);
      color: #e5e7eb;
      padding: 8px 16px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .donor-banner strong {
      color: #ffffff;
    }
    .donor-badge {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.4);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    @media (max-width: 640px) {
      .donor-banner {
        flex-direction: column;
        align-items: flex-start;
      }
    }
    @media (max-width: 768px) {
      body {
        padding: 8px;
      }
      .app {
        padding: 12px 12px 0;
      }
      .layout {
        grid-template-columns: 1fr;
        min-height: auto;
      }
      .map-card {
        min-height: 320px;
      }
      .map-grid-wrapper {
        height: 340px;
      }
      .donor-banner {
        border-radius: 0 0 12px 12px;
        padding: 10px 12px;
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top-bar">
      <div class="title-wrap">
        <h1>Digitalna mapa groblja</h1>
        <div class="subtitle">
          Korisnički prikaz za građane + administrativni dio za unos i održavanje podataka.
        </div>
      </div>
      <div>
        <div class="mode-switch">
          <button id="userModeBtn" class="mode-btn active">Korisnički prikaz</button>
          <button id="adminModeBtn" class="mode-btn">Administratorski dio</button>
        </div>
      </div>
    </div>
    <div class="mode-info" id="modeInfo">
      Trenutno ste u <strong>korisničkom prikazu</strong> – možete pretraživati i gledati lokacije, ali ne možete mijenjati podatke.
    </div>

    <div class="layout">
      <!-- Lijeva strana: pretraga + rezultati + (admin forma + admin slika) -->
      <div>
        <div class="section-title">Pretraga</div>
        <div class="map-author">MAPU PRIPREMIO RIJAD</div>
        <div class="filters">
          <div class="field">
            <label for="name">Ime i prezime</label>
            <input id="name" type="text" placeholder="npr. Meho Hadžić" />
          </div>
          <div class="field">
            <label for="dateFrom">Datum smrti od</label>
            <input id="dateFrom" type="date" />
          </div>
          <div class="field">
            <label for="dateTo">Datum smrti do</label>
            <input id="dateTo" type="date" />
          </div>
          <div>
            <button id="searchBtn">Pretraži</button>
          </div>
        </div>
        <div class="summary" id="summaryText"></div>
        <div class="results-wrapper">
          <table>
            <thead>
              <tr>
                <th>Ime</th>
                <th>Godine</th>
                <th>Parcela / red / grob</th>
                <th id="thActions">Akcije</th>
              </tr>
            </thead>
            <tbody id="resultsBody">
              <!-- Dinamički -->
            </tbody>
          </table>
        </div>

        <div class="form-add" id="formAddWrapper">
          <div class="section-title">
            Administratorski dio – dodavanje / uređivanje zapisa
            <span class="admin-badge">(samo za ovlaštene osobe)</span>
          </div>
          <div id="editModeLabel" class="mode-edit-label" style="display:none;">
            UREĐIVANJE ZAPISA – kliknite "Otkaži uređivanje" da izađete iz režima uređivanja.
          </div>
          <div class="form-add-grid">
            <div class="field">
              <label for="addFirstName">Ime</label>
              <input id="addFirstName" type="text" />
            </div>
            <div class="field">
              <label for="addLastName">Prezime</label>
              <input id="addLastName" type="text" />
            </div>
            <div class="field">
              <label for="addDob">Datum rođenja</label>
              <input id="addDob" type="date" />
            </div>
            <div class="field">
              <label for="addDod">Datum smrti</label>
              <input id="addDod" type="date" />
            </div>
            <div class="field">
              <label for="addSection">Parcela / blok</label>
              <input id="addSection" type="text" placeholder="npr. A" />
            </div>
            <div class="field">
              <label for="addRow">Red</label>
              <input id="addRow" type="number" min="1" />
            </div>
            <div class="field">
              <label for="addPlot">Broj groba</label>
              <input id="addPlot" type="number" min="1" />
            </div>
          </div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <button id="addBtn" class="small">Spasi novi zapis</button>
            <button id="cancelEditBtn" class="small secondary" style="display:none;">Otkaži uređivanje</button>
          </div>
          <div class="status" id="addStatus"></div>

          <!-- ADMIN panel za sliku groblja -->
          <div class="admin-map-panel" id="adminMapPanel">
            <div style="font-weight:600; margin-bottom:4px;">Slika groblja (pozadina mape)</div>
            <label>
              Učitaj sliku groblja (npr. screenshot sa Google Maps):
              <input id="mapFile" type="file" accept="image/*" style="font-size:11px; margin-top:2px;" />
            </label>
            <div style="display:flex; gap:8px; align-items:center; margin-top:4px; flex-wrap:wrap;">
              <button id="uploadMapBtn" class="small">Spasi novu sliku</button>
              <button id="clearMapImg" class="small secondary">Obriši sliku</button>
            </div>
            <div class="legend" style="margin-top:4px;">
              Ova slika se čuva lokalno u <span class="pill">localStorage</span> i prikazuje svima u ovom pregledniku, i u korisničkom i u admin modu.
            </div>
          </div>
        </div>
      </div>

      <!-- Desna strana: velika mapa (2/3 širine) -->
      <div>
        <div class="section-title">Mapa mezarja</div>
        <div class="map-card">
          <div class="map-toolbar">
            <span>Zumiranje mape:</span>
            <button type="button" class="map-zoom-btn" id="zoomOutBtn">−</button>
            <button type="button" class="map-zoom-btn" id="zoomInBtn">+</button>
          </div>
          <div class="map-grid-wrapper" id="mapGridWrapper">
            <div class="map-inner" id="mapInner">
              <!-- Jedna slika mape – ista svuda -->
              <img id="mapImage" alt="Mapa mezarja" src="mapa-groblja.png" />
              <!-- Markeri idu iznad slike -->
            </div>
          </div>
          <div class="legend">
            Kliknite na red u tabeli da označite grob na mapi. U admin modu kliknite na mapu da postavite / promijenite poziciju groba.
          </div>
        </div>
      </div>
    </div>

    <div class="donor-banner">
      <div>
        <strong>Digitalna mapa mezarja Kolijevke</strong><br />
        Projekat podržan od građana i razvijen od strane vijećnika Rijada Adžovića.
      </div>
      <div class="donor-badge">
        BETA VERZIJA – TESTNO OKRUŽENJE
      </div>
    </div>
  </div>

  <script>
    // --- GLOBALNE VARIJABLE ---
    const LOCAL_KEY_GRAVES = "graveyard_records_v1";
    const LOCAL_KEY_MAP_IMG = "graveyardMapImage_v1";

    let graves = [];
    let currentMode = "user"; // 'user' ili 'admin'
    let selectedGraveId = null;
    let editingId = null;
    let pendingCoords = null; // koordinate za novi zapis
    let currentZoom = 1;

    // --- ELEMENTI ---
    const userModeBtn = document.getElementById("userModeBtn");
    const adminModeBtn = document.getElementById("adminModeBtn");
    const modeInfo = document.getElementById("modeInfo");

    const formAddWrapper = document.getElementById("formAddWrapper");
    const adminMapPanel = document.getElementById("adminMapPanel");
    const editModeLabel = document.getElementById("editModeLabel");
    const thActions = document.getElementById("thActions");
    const resultsBody = document.getElementById("resultsBody");
    const summaryText = document.getElementById("summaryText");

    const addFirstName = document.getElementById("addFirstName");
    const addLastName = document.getElementById("addLastName");
    const addDob = document.getElementById("addDob");
    const addDod = document.getElementById("addDod");
    const addSection = document.getElementById("addSection");
    const addRow = document.getElementById("addRow");
    const addPlot = document.getElementById("addPlot");
    const addBtn = document.getElementById("addBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const addStatus = document.getElementById("addStatus");

    const mapFileInput = document.getElementById("mapFile");
    const uploadMapBtn = document.getElementById("uploadMapBtn");
    const clearMapImgBtn = document.getElementById("clearMapImg");
    const mapImage = document.getElementById("mapImage");
    const mapGridWrapper = document.getElementById("mapGridWrapper");
    const mapInner = document.getElementById("mapInner");

    const zoomInBtn = document.getElementById("zoomInBtn");
    const zoomOutBtn = document.getElementById("zoomOutBtn");

    const nameInput = document.getElementById("name");
    const dateFromInput = document.getElementById("dateFrom");
    const dateToInput = document.getElementById("dateTo");
    const searchBtn = document.getElementById("searchBtn");

    // --- POMOĆNE FUNKCIJE ---

    function loadGraves() {
      try {
        const data = localStorage.getItem(LOCAL_KEY_GRAVES);
        graves = data ? JSON.parse(data) : [];
      } catch (e) {
        graves = [];
      }
    }

    function saveGraves() {
      localStorage.setItem(LOCAL_KEY_GRAVES, JSON.stringify(graves));
    }

    function loadMapImage() {
      const data = localStorage.getItem(LOCAL_KEY_MAP_IMG);
      if (data) {
        mapImage.src = data;
      } else {
        // ako nema u localStorage, koristi default fajl u projektu
        mapImage.src = "mapa-groblja.png";
      }
    }

    function setMode(mode) {
      currentMode = mode;
      if (mode === "user") {
        userModeBtn.classList.add("active");
        adminModeBtn.classList.remove("active");
        modeInfo.innerHTML = "Trenutno ste u <strong>korisničkom prikazu</strong> – možete pretraživati i gledati lokacije, ali ne možete mijenjati podatke.";
        formAddWrapper.style.display = "none";
        adminMapPanel.style.display = "none";
        thActions.style.display = "none";
      } else {
        adminModeBtn.classList.add("active");
        userModeBtn.classList.remove("active");
        modeInfo.innerHTML = "Trenutno ste u <strong>administratorskom prikazu</strong> – možete dodavati, uređivati i brisati zapise te mijenjati sliku mape.";
        formAddWrapper.style.display = "block";
        adminMapPanel.style.display = "block";
        thActions.style.display = "";
      }
      renderTable();
      renderMarkers();
    }

    function clearForm() {
      addFirstName.value = "";
      addLastName.value = "";
      addDob.value = "";
      addDod.value = "";
      addSection.value = "";
      addRow.value = "";
      addPlot.value = "";
      addStatus.textContent = "";
      addStatus.classList.remove("error");
      pendingCoords = null;
    }

    function startEdit(grave) {
      editingId = grave.id;
      addFirstName.value = grave.firstName || "";
      addLastName.value = grave.lastName || "";
      addDob.value = grave.dob || "";
      addDod.value = grave.dod || "";
      addSection.value = grave.section || "";
      addRow.value = grave.row || "";
      addPlot.value = grave.plot || "";
      addStatus.textContent = "Uređujete zapis – klik na mapu mijenja poziciju ovog groba.";
      addStatus.classList.remove("error");
      editModeLabel.style.display = "block";
      cancelEditBtn.style.display = "inline-flex";
      addBtn.textContent = "Spasi izmjene";
    }

    function cancelEdit() {
      editingId = null;
      editModeLabel.style.display = "none";
      cancelEditBtn.style.display = "none";
      addBtn.textContent = "Spasi novi zapis";
      clearForm();
    }

    function getFilters() {
      const name = (nameInput.value || "").trim().toLowerCase();
      const df = dateFromInput.value ? new Date(dateFromInput.value) : null;
      const dt = dateToInput.value ? new Date(dateToInput.value) : null;
      return { name, df, dt };
    }

    function applyFilters(list) {
      const { name, df, dt } = getFilters();
      return list.filter(g => {
        let ok = true;
        if (name) {
          const full = ((g.firstName || "") + " " + (g.lastName || "")).toLowerCase();
          ok = ok && full.includes(name);
        }
        if (df || dt) {
          if (!g.dod) return false;
          const gd = new Date(g.dod);
          if (df && gd < df) ok = false;
          if (dt && gd > dt) ok = false;
        }
        return ok;
      });
    }

    function renderSummary(filtered) {
      if (!filtered.length) {
        summaryText.textContent = "Nema rezultata za zadane kriterije.";
      } else {
        summaryText.textContent = `Pronađeno zapisa: ${filtered.length}`;
      }
    }

    function highlightSelectedRow() {
      const rows = resultsBody.querySelectorAll("tr");
      rows.forEach(tr => {
        const id = tr.getAttribute("data-id");
        if (id && parseInt(id, 10) === selectedGraveId) {
          tr.classList.add("selected");
        } else {
          tr.classList.remove("selected");
        }
      });
    }

    function renderTable() {
      const filtered = applyFilters(graves);
      resultsBody.innerHTML = "";
      filtered.forEach(g => {
        const tr = document.createElement("tr");
        tr.setAttribute("data-id", g.id);

        const fullName = [g.firstName, g.lastName].filter(Boolean).join(" ");
        const years = (g.dob && g.dod) ? `${g.dob.slice(0,4)}–${g.dod.slice(0,4)}` : "";
        const loc = `${g.section || ""} / ${g.row || ""} / ${g.plot || ""}`;

        const nameTd = document.createElement("td");
        nameTd.textContent = fullName;

        const yearsTd = document.createElement("td");
        yearsTd.textContent = years;

        const locTd = document.createElement("td");
        locTd.textContent = loc;

        const actionsTd = document.createElement("td");
        actionsTd.className = "actions-cell";

        if (currentMode === "admin") {
          const editBtnEl = document.createElement("button");
          editBtnEl.textContent = "Uredi";
          editBtnEl.className = "small";
          editBtnEl.addEventListener("click", (e) => {
            e.stopPropagation();
            startEdit(g);
          });

          const delBtnEl = document.createElement("button");
          delBtnEl.textContent = "Obriši";
          delBtnEl.className = "small danger";
          delBtnEl.addEventListener("click", (e) => {
            e.stopPropagation();
            if (confirm("Sigurno želite obrisati ovaj zapis?")) {
              graves = graves.filter(x => x.id !== g.id);
              saveGraves();
              if (selectedGraveId === g.id) selectedGraveId = null;
              if (editingId === g.id) cancelEdit();
              renderTable();
              renderMarkers();
            }
          });

          actionsTd.appendChild(editBtnEl);
          actionsTd.appendChild(delBtnEl);
          actionsTd.style.display = "";
        } else {
          actionsTd.style.display = "none";
        }

        tr.appendChild(nameTd);
        tr.appendChild(yearsTd);
        tr.appendChild(locTd);
        tr.appendChild(actionsTd);

        tr.addEventListener("click", () => {
          selectedGraveId = g.id;
          highlightSelectedRow();
          renderMarkers();
        });

        resultsBody.appendChild(tr);
      });

      renderSummary(filtered);
      highlightSelectedRow();
    }

    function renderMarkers() {
      // obriši stare markere
      mapInner.querySelectorAll(".marker").forEach(m => m.remove());

      graves.forEach(g => {
        if (g.x == null || g.y == null) return;
        const marker = document.createElement("div");
        marker.className = "marker";
        if (g.id === selectedGraveId) {
          marker.classList.add("selected");
        }
        marker.style.left = g.x + "%";
        marker.style.top = g.y + "%";
        marker.addEventListener("click", (e) => {
          e.stopPropagation();
          selectedGraveId = g.id;
          highlightSelectedRow();
          renderMarkers();
        });
        mapInner.appendChild(marker);
      });
    }

    function applyZoom() {
      mapInner.style.transform = `scale(${currentZoom})`;
    }

    function mapClickHandler(e) {
      if (currentMode !== "admin") return;

      // klik relativno na mapInner
      const rect = mapInner.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width) * 100;
      const y = ((e.clientY - rect.top) / rect.height) * 100;

      pendingCoords = { x, y };

      if (editingId != null) {
        const g = graves.find(gr => gr.id === editingId);
        if (g) {
          g.x = x;
          g.y = y;
          saveGraves();
          addStatus.textContent = "Pozicija groba je ažurirana klikom na mapu. Ne zaboravite spasiti izmjene.";
          addStatus.classList.remove("error");
          renderMarkers();
        }
      } else {
        addStatus.textContent = "Pozicija za novi grob je zapamćena – sada možete spasiti novi zapis.";
        addStatus.classList.remove("error");
      }
    }

    // --- EVENT LISTENERS ---

    userModeBtn.addEventListener("click", () => setMode("user"));
    adminModeBtn.addEventListener("click", () => setMode("admin"));

    searchBtn.addEventListener("click", () => {
      renderTable();
      renderMarkers();
    });

    // pretraga na Enter u polju ime
    nameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        renderTable();
        renderMarkers();
      }
    });

    addBtn.addEventListener("click", () => {
      const fn = addFirstName.value.trim();
      const ln = addLastName.value.trim();
      const dob = addDob.value || "";
      const dod = addDod.value || "";
      const sec = addSection.value.trim();
      const row = addRow.value ? parseInt(addRow.value, 10) : null;
      const plot = addPlot.value ? parseInt(addPlot.value, 10) : null;

      if (!fn || !ln) {
        addStatus.textContent = "Ime i prezime su obavezni.";
        addStatus.classList.add("error");
        return;
      }

      if (editingId != null) {
        // izmjena postojećeg
        const g = graves.find(gr => gr.id === editingId);
        if (g) {
          g.firstName = fn;
          g.lastName = ln;
          g.dob = dob;
          g.dod = dod;
          g.section = sec;
          g.row = row;
          g.plot = plot;
          // koordinate su već ažurirane klikom na mapu (ako je bilo)
          saveGraves();
          addStatus.textContent = "Zapis je uspješno ažuriran.";
          addStatus.classList.remove("error");
          renderTable();
          renderMarkers();
        }
      } else {
        // novi zapis
        if (!pendingCoords) {
          addStatus.textContent = "Kliknite na mapu da postavite poziciju groba prije spremanja.";
          addStatus.classList.add("error");
          return;
        }
        const newGrave = {
          id: Date.now(),
          firstName: fn,
          lastName: ln,
          dob,
          dod,
          section: sec,
          row,
          plot,
          x: pendingCoords.x,
          y: pendingCoords.y
        };
        graves.push(newGrave);
        saveGraves();
        addStatus.textContent = "Novi zapis je uspješno spremljen.";
        addStatus.classList.remove("error");
        selectedGraveId = newGrave.id;
        clearForm();
        renderTable();
        renderMarkers();
      }
    });

    cancelEditBtn.addEventListener("click", () => {
      cancelEdit();
    });

    uploadMapBtn.addEventListener("click", () => {
      const file = mapFileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        localStorage.setItem(LOCAL_KEY_MAP_IMG, reader.result);
        mapImage.src = reader.result;
        alert("Slika mape je spremljena za ovaj uređaj.");
      };
      reader.readAsDataURL(file);
    });

    clearMapImgBtn.addEventListener("click", () => {
      if (confirm("Obrisati spremljenu sliku mape za ovaj uređaj?")) {
        localStorage.removeItem(LOCAL_KEY_MAP_IMG);
        mapImage.src = "mapa-groblja.png";
      }
    });

    zoomInBtn.addEventListener("click", () => {
      currentZoom = Math.min(currentZoom + 0.2, 3);
      applyZoom();
    });

    zoomOutBtn.addEventListener("click", () => {
      currentZoom = Math.max(currentZoom - 0.2, 0.5);
      applyZoom();
    });

    mapGridWrapper.addEventListener("click", mapClickHandler);

    // --- INIT ---
    (function init() {
      loadGraves();
      loadMapImage();
      setMode("user");
      applyZoom();
      renderTable();
      renderMarkers();
    })();
  </script>
</body>
</html>
