<!DOCTYPE html>
<html lang="bs">
<head>
  <meta charset="UTF-8" />
  <title>Digitalna mapa groblja – korisnici i administratori</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 16px;
      background: #f3f4f6;
    }
    h1 {
      margin-top: 0;
    }
    .app {
      max-width: 1400px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 16px 16px 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }
    .title-wrap {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .subtitle {
      font-size: 12px;
      color: #4b5563;
    }
    .mode-switch {
      display: inline-flex;
      border-radius: 999px;
      background: #e5e7eb;
      padding: 2px;
      align-items: center;
      gap: 2px;
    }
    .mode-btn {
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      background: transparent;
      color: #4b5563;
      transition: background 0.15s, color 0.15s;
      white-space: nowrap;
    }
    .mode-btn.active {
      background: #2563eb;
      color: #ffffff;
    }
    .mode-info {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 12px;
    }
    .layout {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 16px;
      min-height: 70vh;
    }
    @media (max-width: 960px) {
      .layout {
        grid-template-columns: 1fr;
      }
      .top-bar {
        flex-direction: column;
        align-items: flex-start;
      }
    }
    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin: 8px 0 4px 0;
      color: #111827;
    }
    .map-author {
      font-size: 11px;
      color: #4b5563;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
      align-items: flex-end;
    }
    .field {
      display: flex;
      flex-direction: column;
      min-width: 150px;
      flex: 1;
    }
    label {
      font-size: 12px;
      margin-bottom: 4px;
      color: #374151;
    }
    input, select {
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
    }
    button {
      padding: 9px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      background: #2563eb;
      color: white;
      transition: transform 0.05s ease, box-shadow 0.05s ease, opacity 0.15s;
      white-space: nowrap;
    }
    button.secondary {
      background: #6b7280;
    }
    button.danger {
      background: #dc2626;
    }
    button.small {
      padding: 6px 10px;
      font-size: 12px;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 12px rgba(37,99,235,0.35);
      opacity: 0.95;
    }
    button:active {
      transform: translateY(0);
      box-shadow: none;
    }
    .results-wrapper {
      max-height: 260px;
      overflow: auto;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      text-align: left;
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
    }
    th {
      background: #f9fafb;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr {
      cursor: pointer;
    }
    tbody tr:hover {
      background: #eff6ff;
    }
    tbody tr.selected {
      background: #dbeafe;
    }
    .map-toolbar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
      font-size: 11px;
      color: #4b5563;
    }
    .map-zoom-btn {
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      box-shadow: 0 1px 2px rgba(15,23,42,0.06);
    }
    .map-zoom-btn:active {
      transform: scale(0.97);
    }
    .summary {
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 6px;
      min-height: 16px;
    }
    .map-card {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 10px;
      background: #f9fafb;
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: 100%;
    }
    .map-grid-wrapper {
      position: relative;
      width: 100%;
      flex: 1;
      border-radius: 10px;
      overflow: auto;
      touch-action: pan-x pan-y;
      background:
        repeating-linear-gradient(
          to right,
          #e5e7eb 0,
          #e5e7eb 1px,
          transparent 1px,
          transparent calc(100%/12)
        ),
        repeating-linear-gradient(
          to bottom,
          #e5e7eb 0,
          #e5e7eb 1px,
          transparent 1px,
          transparent calc(100%/12)
        );
    }
    .map-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transform-origin: top left;
    }
    #mapImage {
      position: relative;
      width: 100%;
      height: auto;
      display: block;
    }
    .marker {
      position: absolute;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #dc2626;
      border: 2px solid #ffffff;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 0 3px rgba(220,38,38,0.35);
      pointer-events: none;
    }
    .legend {
      font-size: 11px;
      color: #6b7280;
    }
    .map-label {
      font-size: 12px;
      color: #4b5563;
    }
    .pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 11px;
      color: #374151;
    }
    .form-add {
      margin-top: 12px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      padding: 10px;
      background: #f9fafb;
    }
    .form-add-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }
    .status {
      font-size: 11px;
      color: #059669;
      min-height: 14px;
    }
    .status.error {
      color: #dc2626;
    }
    .mode-edit {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.3);
    }
    .mode-edit-label {
      font-size: 11px;
      color: #1d4ed8;
      margin-bottom: 4px;
    }
    .actions-cell button {
      margin-right: 4px;
    }
    .hidden {
      display: none !important;
    }
    .admin-badge {
      font-size: 11px;
      color: #16a34a;
      margin-left: 4px;
    }
    .admin-map-panel {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px dashed #d1d5db;
      font-size: 11px;
      color: #374151;
    }
    .admin-map-panel label {
      font-size: 11px;
      margin-bottom: 2px;
    }
    .donor-banner {
      margin-top: 8px;
      border-radius: 0 0 12px 12px;
      background: linear-gradient(90deg, #111827, #1d4ed8);
      color: #e5e7eb;
      padding: 8px 16px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .donor-banner strong {
      color: #ffffff;
    }
    .donor-badge {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.4);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    @media (max-width: 640px) {
      .donor-banner {
        flex-direction: column;
        align-items: flex-start;
      }
    }
    @media (max-width: 768px) {
      body {
        padding: 8px;
      }
      .app {
        padding: 12px 12px 0;
      }
      .layout {
        grid-template-columns: 1fr;
        min-height: auto;
      }
      .map-card {
        min-height: 320px;
      }
      .map-grid-wrapper {
        height: 340px;
      }
      .donor-banner {
        border-radius: 0 0 12px 12px;
        padding: 10px 12px;
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top-bar">
      <div class="title-wrap">
        <h1>Digitalna mapa groblja</h1>
        <div class="subtitle">
          Korisnički prikaz za građane + administrativni dio za unos i održavanje podataka.
        </div>
      </div>
      <div>
        <div class="mode-switch">
          <button id="userModeBtn" class="mode-btn active">Korisnički prikaz</button>
          <button id="adminModeBtn" class="mode-btn">Administratorski dio</button>
        </div>
      </div>
    </div>
    <div class="mode-info" id="modeInfo">
      Trenutno ste u <strong>korisničkom prikazu</strong> – možete pretraživati i gledati lokacije, ali ne možete mijenjati podatke.
    </div>

    <div class="layout">
      <!-- Lijeva strana -->
      <div>
        <div class="section-title">Pretraga</div>
        <div class="map-author">MAPU PRIPREMIO RIJAD</div>
        <div class="filters">
          <div class="field">
            <label for="name">Ime i prezime</label>
            <input id="name" type="text" placeholder="npr. Meho Hadžić" />
          </div>
          <div class="field">
            <label for="dateFrom">Datum smrti od</label>
            <input id="dateFrom" type="date" />
          </div>
          <div class="field">
            <label for="dateTo">Datum smrti do</label>
            <input id="dateTo" type="date" />
          </div>
          <div>
            <button id="searchBtn">Pretraži</button>
          </div>
        </div>
        <div class="summary" id="summaryText"></div>
        <div class="results-wrapper">
          <table>
            <thead>
              <tr>
                <th>Ime</th>
                <th>Godine</th>
                <th>Parcela / red / grob</th>
                <th id="thActions">Akcije</th>
              </tr>
            </thead>
            <tbody id="resultsBody">
              <!-- Dinamički -->
            </tbody>
          </table>
        </div>

        <div class="form-add" id="formAddWrapper">
          <div class="section-title">
            Administratorski dio – dodavanje / uređivanje zapisa
            <span class="admin-badge">(samo za ovlaštene osobe)</span>
          </div>
          <div id="editModeLabel" class="mode-edit-label" style="display:none;">
            UREĐIVANJE ZAPISA – kliknite "Otkaži uređivanje" da izađete iz režima uređivanja.
          </div>
          <div class="form-add-grid">
            <div class="field">
              <label for="addFirstName">Ime</label>
              <input id="addFirstName" type="text" />
            </div>
            <div class="field">
              <label for="addLastName">Prezime</label>
              <input id="addLastName" type="text" />
            </div>
            <div class="field">
              <label for="addDob">Datum rođenja</label>
              <input id="addDob" type="date" />
            </div>
            <div class="field">
              <label for="addDod">Datum smrti</label>
              <input id="addDod" type="date" />
            </div>
            <div class="field">
              <label for="addSection">Parcela / blok</label>
              <input id="addSection" type="text" placeholder="npr. A" />
            </div>
            <div class="field">
              <label for="addRow">Red</label>
              <input id="addRow" type="number" min="1" />
            </div>
            <div class="field">
              <label for="addPlot">Broj groba</label>
              <input id="addPlot" type="number" min="1" />
            </div>
          </div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <button id="addBtn" class="small">Spasi zapis</button>
            <button id="cancelEditBtn" class="small secondary" style="display:none;">Otkaži uređivanje</button>
          </div>
          <div class="status" id="addStatus"></div>

          <!-- ADMIN panel za sliku groblja -->
          <div class="admin-map-panel" id="adminMapPanel">
            <div style="font-weight:600; margin-bottom:4px;">Slika groblja (pozadina mape)</div>
            <label>
              Učitaj sliku groblja (npr. screenshot sa Google Maps):
              <input id="mapFile" type="file" accept="image/*" style="font-size:11px; margin-top:2px;" />
            </label>
            <div style="display:flex; gap:8px; align-items:center; margin-top:4px; flex-wrap:wrap;">
              <button id="uploadMapBtn" class="small">Spasi novu sliku</button>
              <button id="clearMapImg" class="small secondary">Obriši sliku</button>
            </div>
            <div class="legend" style="margin-top:4px;">
              Ova slika će se prikazivati desno kao pozadina mape svim korisnicima. Čuva se lokalno u
              <span class="pill">localStorage</span>.
            </div>
          </div>
          <div class="legend" style="margin-top:6px;">
            U administratorskom modu: odaberite zapis u tabeli, zatim kliknite na mapu da postavite tačnu lokaciju groba.
          </div>
        </div>
      </div>

      <!-- Desna strana: mapa -->
      <div>
        <div class="section-title">Mapa mezarja</div>
        <div class="map-card">
          <div class="map-toolbar">
            <span>Zumiranje mape:</span>
            <button type="button" class="map-zoom-btn" id="zoomOutBtn">−</button>
            <button type="button" class="map-zoom-btn" id="zoomInBtn">+</button>
          </div>
          <div class="map-grid-wrapper" id="mapGridWrapper">
            <div class="map-inner" id="mapInner">
              <!-- Početno prazna slika – učitava se kroz admin panel -->
              <img id="mapImage" alt="Mapa mezarja" src="" />
            </div>
          </div>
          <div class="legend">
            Klik na rezultat u tabeli prikazuje marker na mapi. U admin modu možete kliknuti na mapu da zabilježite tačnu lokaciju groba.
          </div>
        </div>
      </div>
    </div>

    <div class="donor-banner">
      <div>
        Ovaj alat razvijen je za olakšanu pretragu i orijentaciju na mezarju Kolijevke.
        <strong>Podaci se čuvaju lokalno u vašem pregledniku.</strong>
      </div>
      <div class="donor-badge">Pilot verzija</div>
    </div>
  </div>

  <script>
    (function () {
      // DOM elementi
      const userModeBtn = document.getElementById('userModeBtn');
      const adminModeBtn = document.getElementById('adminModeBtn');
      const modeInfo = document.getElementById('modeInfo');

      const nameInput = document.getElementById('name');
      const dateFromInput = document.getElementById('dateFrom');
      const dateToInput = document.getElementById('dateTo');
      const searchBtn = document.getElementById('searchBtn');
      const summaryText = document.getElementById('summaryText');
      const resultsBody = document.getElementById('resultsBody');

      const formAddWrapper = document.getElementById('formAddWrapper');
      const editModeLabel = document.getElementById('editModeLabel');
      const addFirstName = document.getElementById('addFirstName');
      const addLastName = document.getElementById('addLastName');
      const addDob = document.getElementById('addDob');
      const addDod = document.getElementById('addDod');
      const addSection = document.getElementById('addSection');
      const addRow = document.getElementById('addRow');
      const addPlot = document.getElementById('addPlot');
      const addBtn = document.getElementById('addBtn');
      const cancelEditBtn = document.getElementById('cancelEditBtn');
      const addStatus = document.getElementById('addStatus');

      const adminMapPanel = document.getElementById('adminMapPanel');
      const mapFileInput = document.getElementById('mapFile');
      const uploadMapBtn = document.getElementById('uploadMapBtn');
      const clearMapImgBtn = document.getElementById('clearMapImg');

      const mapGridWrapper = document.getElementById('mapGridWrapper');
      const mapInner = document.getElementById('mapInner');
      const mapImage = document.getElementById('mapImage');
      const zoomInBtn = document.getElementById('zoomInBtn');
      const zoomOutBtn = document.getElementById('zoomOutBtn');

      const MAP_STORAGE_KEY = 'digitalnaMapa_groblje_data';
      const MAP_IMAGE_KEY = 'digitalnaMapa_groblje_image';
      const defaultMapSrc = mapImage.getAttribute('src') || '';

      let mode = 'user';
      let graves = [];
      let filteredGraves = [];
      let selectedId = null;
      let editingId = null;
      let markerEl = null;

      let zoomLevel = 1;
      const MIN_ZOOM = 0.6;
      const MAX_ZOOM = 2.0;
      const ZOOM_STEP = 0.2;

      function loadData() {
        try {
          const raw = localStorage.getItem(MAP_STORAGE_KEY);
          graves = raw ? JSON.parse(raw) : [];
        } catch (e) {
          graves = [];
        }
        filteredGraves = graves.slice();
      }

      function saveData() {
        localStorage.setItem(MAP_STORAGE_KEY, JSON.stringify(graves));
      }

      function loadMapImage() {
        const stored = localStorage.getItem(MAP_IMAGE_KEY);
        if (stored) {
          mapImage.src = stored;
        }
      }

      function applyZoom() {
        mapInner.style.transform = 'scale(' + zoomLevel + ')';
        mapInner.style.transformOrigin = 'top left';
      }

      function setMode(newMode) {
        mode = newMode;
        if (mode === 'user') {
          userModeBtn.classList.add('active');
          adminModeBtn.classList.remove('active');
          formAddWrapper.style.display = 'none';
          modeInfo.innerHTML =
            'Trenutno ste u <strong>korisničkom prikazu</strong> – možete pretraživati i gledati lokacije, ali ne možete mijenjati podatke.';
        } else {
          adminModeBtn.classList.add('active');
          userModeBtn.classList.remove('active');
          formAddWrapper.style.display = 'block';
          modeInfo.innerHTML =
            'Trenutno ste u <strong>administratorskom prikazu</strong> – možete dodavati, uređivati i brisati zapise, te postavljati lokacije na mapi.';
        }
        renderResults();
      }

      function clearMarker() {
        if (markerEl) {
          markerEl.remove();
          markerEl = null;
        }
      }

      function ensureMarker() {
        if (!markerEl) {
          markerEl = document.createElement('div');
          markerEl.className = 'marker';
          mapInner.appendChild(markerEl);
        }
      }

      function centerOnMarker() {
        if (!markerEl) return;
        const wrapperRect = mapGridWrapper.getBoundingClientRect();
        const markerRect = markerEl.getBoundingClientRect();
        const offsetX =
          markerRect.left + markerRect.width / 2 - (wrapperRect.left + wrapperRect.width / 2);
        const offsetY =
          markerRect.top + markerRect.height / 2 - (wrapperRect.top + wrapperRect.height / 2);
        mapGridWrapper.scrollLeft += offsetX;
        mapGridWrapper.scrollTop += offsetY;
      }

      function showMarker(grave) {
        if (!grave || typeof grave.x !== 'number' || typeof grave.y !== 'number') {
          clearMarker();
          return;
        }
        ensureMarker();
        markerEl.style.left = grave.x + '%';
        markerEl.style.top = grave.y + '%';
        centerOnMarker();
      }

      function formatYears(dob, dod) {
        if (!dob && !dod) return '';
        const dobY = dob ? dob.slice(0, 4) : '';
        const dodY = dod ? dod.slice(0, 4) : '';
        if (dobY && dodY) return dobY + '–' + dodY;
        return dobY || dodY;
      }

      function formatParcel(g) {
        const parts = [];
        if (g.section) parts.push(g.section);
        if (g.row) parts.push('red ' + g.row);
        if (g.plot) parts.push('grob ' + g.plot);
        return parts.join(' / ');
      }

      function applyFilters() {
        let list = graves.slice();
        const nameQuery = nameInput.value.trim().toLowerCase();
        const from = dateFromInput.value;
        const to = dateToInput.value;

        if (nameQuery) {
          list = list.filter((g) => {
            const fullName = ((g.firstName || '') + ' ' + (g.lastName || '')).toLowerCase();
            return fullName.includes(nameQuery);
          });
        }

        if (from) {
          list = list.filter((g) => !g.dod || g.dod >= from);
        }
        if (to) {
          list = list.filter((g) => !g.dod || g.dod <= to);
        }

        filteredGraves = list;
        renderResults();
      }

      function resetForm() {
        editingId = null;
        addFirstName.value = '';
        addLastName.value = '';
        addDob.value = '';
        addDod.value = '';
        addSection.value = '';
        addRow.value = '';
        addPlot.value = '';
        addStatus.textContent = '';
        addStatus.classList.remove('error');
        editModeLabel.style.display = 'none';
        cancelEditBtn.style.display = 'none';
        formAddWrapper.classList.remove('mode-edit');
      }

      function startEdit(grave) {
        editingId = grave.id;
        addFirstName.value = grave.firstName || '';
        addLastName.value = grave.lastName || '';
        addDob.value = grave.dob || '';
        addDod.value = grave.dod || '';
        addSection.value = grave.section || '';
        addRow.value = grave.row != null ? grave.row : '';
        addPlot.value = grave.plot != null ? grave.plot : '';
        editModeLabel.style.display = 'block';
        cancelEditBtn.style.display = 'inline-block';
        formAddWrapper.classList.add('mode-edit');
        addStatus.textContent = 'Uređujete postojeći zapis – kliknite na mapu za promjenu lokacije.';
        addStatus.classList.remove('error');
      }

      function renderResults() {
        resultsBody.innerHTML = '';

        if (!graves.length) {
          summaryText.textContent =
            mode === 'admin'
              ? 'Još uvijek nema unesenih zapisa. Dodajte prvi zapis u formi ispod.'
              : 'Još uvijek nema dostupnih podataka.';
          clearMarker();
          return;
        }

        const list = filteredGraves && filteredGraves.length ? filteredGraves : [];

        if (!list.length) {
          summaryText.textContent = 'Nema rezultata za zadane filtere.';
          clearMarker();
          return;
        }

        // Ako nema selekcije a postoji tačno jedan rezultat, automatski ga selektuj
        if (selectedId == null && list.length === 1) {
          selectedId = list[0].id;
        }

        summaryText.textContent = 'Pronađeno zapisa: ' + list.length;

        list.forEach((g) => {
          const tr = document.createElement('tr');
          if (g.id === selectedId) {
            tr.classList.add('selected');
          }

          const tdName = document.createElement('td');
          tdName.textContent = (g.firstName || '') + ' ' + (g.lastName || '');

          const tdYears = document.createElement('td');
          tdYears.textContent = formatYears(g.dob, g.dod);

          const tdParcel = document.createElement('td');
          tdParcel.textContent = formatParcel(g);

          const tdActions = document.createElement('td');
          tdActions.className = 'actions-cell';
          if (mode === 'admin') {
            const editBtnEl = document.createElement('button');
            editBtnEl.textContent = 'Uredi';
            editBtnEl.className = 'small';
            editBtnEl.addEventListener('click', function (ev) {
              ev.stopPropagation();
              startEdit(g);
            });

            const delBtnEl = document.createElement('button');
            delBtnEl.textContent = 'Obriši';
            delBtnEl.className = 'small danger';
            delBtnEl.addEventListener('click', function (ev) {
              ev.stopPropagation();
              if (confirm('Da li sigurno želite obrisati ovaj zapis?')) {
                graves = graves.filter((x) => x.id !== g.id);
                if (selectedId === g.id) selectedId = null;
                if (editingId === g.id) resetForm();
                saveData();
                applyFilters();
              }
            });

            tdActions.appendChild(editBtnEl);
            tdActions.appendChild(delBtnEl);
          } else {
            tdActions.textContent = '';
          }

          tr.appendChild(tdName);
          tr.appendChild(tdYears);
          tr.appendChild(tdParcel);
          tr.appendChild(tdActions);

          tr.addEventListener('click', function () {
            selectedId = g.id;
            showMarker(g);
            centerOnMarker();
            renderResults();
          });

          resultsBody.appendChild(tr);
        });

        const selected = graves.find((g) => g.id === selectedId);
        if (selected) {
          showMarker(selected);
        }
      }

      // Eventi za modove
      userModeBtn.addEventListener('click', function () {
        setMode('user');
      });
      adminModeBtn.addEventListener('click', function () {
        setMode('admin');
      });

      // Pretraga
      searchBtn.addEventListener('click', function () {
        applyFilters();
      });
      nameInput.addEventListener('keyup', function (e) {
        if (e.key === 'Enter') applyFilters();
      });

      // Dodavanje / uređivanje zapisa
      addBtn.addEventListener('click', function (e) {
        e.preventDefault();

        const firstName = addFirstName.value.trim();
        const lastName = addLastName.value.trim();
        const dob = addDob.value || '';
        const dod = addDod.value || '';
        const section = addSection.value.trim();
        const row = addRow.value ? parseInt(addRow.value, 10) : null;
        const plot = addPlot.value ? parseInt(addPlot.value, 10) : null;

        if (!firstName || !lastName) {
          addStatus.textContent = 'Ime i prezime su obavezni.';
          addStatus.classList.add('error');
          return;
        }

        let grave;
        if (editingId) {
          grave = graves.find((g) => g.id === editingId);
          if (!grave) {
            addStatus.textContent = 'Greška: zapis nije pronađen.';
            addStatus.classList.add('error');
            return;
          }
          grave.firstName = firstName;
          grave.lastName = lastName;
          grave.dob = dob;
          grave.dod = dod;
          grave.section = section;
          grave.row = row;
          grave.plot = plot;
          addStatus.textContent =
            'Zapis je ažuriran. Kliknite na mapu da po potrebi promijenite lokaciju groba.';
          addStatus.classList.remove('error');
        } else {
          grave = {
            id: Date.now(),
            firstName,
            lastName,
            dob,
            dod,
            section,
            row,
            plot,
            x: null,
            y: null
          };
          graves.push(grave);
          addStatus.textContent =
            'Novi zapis je sačuvan. Sada ga odaberite u tabeli i kliknite na mapu da postavite lokaciju.';
          addStatus.classList.remove('error');
        }

        saveData();
        applyFilters();
        resetForm();
      });

      cancelEditBtn.addEventListener('click', function () {
        resetForm();
      });

      // Klik na mapu u admin modu: postavljanje lokacije
      mapInner.addEventListener('click', function (e) {
        if (mode !== 'admin') return;

        const targetId = editingId || selectedId;
        if (!targetId) {
          alert('Prvo odaberite zapis u tabeli ili otvorite uređivanje.');
          return;
        }

        const rect = mapInner.getBoundingClientRect();
        const xPercent = ((e.clientX - rect.left) / rect.width) * 100;
        const yPercent = ((e.clientY - rect.top) / rect.height) * 100;

        const grave = graves.find((g) => g.id === targetId);
        if (!grave) return;

        grave.x = xPercent;
        grave.y = yPercent;

        saveData();
        addStatus.textContent = 'Lokacija groba je spašena. Biće ista na mobitelu i računaru.';
        addStatus.classList.remove('error');
        showMarker(grave);
        applyFilters();
      });

      // Učitavanje slike mape
      uploadMapBtn.addEventListener('click', function () {
        const file = mapFileInput.files && mapFileInput.files[0];
        if (!file) {
          alert('Molimo odaberite sliku mape.');
          return;
        }
        const reader = new FileReader();
        reader.onload = function (evt) {
          const dataUrl = evt.target.result;
          mapImage.src = dataUrl;
          localStorage.setItem(MAP_IMAGE_KEY, dataUrl);
        };
        reader.readAsDataURL(file);
      });

      clearMapImgBtn.addEventListener('click', function () {
        localStorage.removeItem(MAP_IMAGE_KEY);
        mapImage.src = defaultMapSrc || '';
      });

      // Zumiranje
      zoomInBtn.addEventListener('click', function () {
        zoomLevel = Math.min(MAX_ZOOM, zoomLevel + ZOOM_STEP);
        applyZoom();
      });

      zoomOutBtn.addEventListener('click', function () {
        zoomLevel = Math.max(MIN_ZOOM, zoomLevel - ZOOM_STEP);
        applyZoom();
      });

      // Inicijalizacija
      loadData();
      loadMapImage();
      applyZoom();
      setMode('user');
      applyFilters();
    })();
  </script>
</body>
</html>
