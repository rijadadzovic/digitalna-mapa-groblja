<!DOCTYPE html>
<html lang="bs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Digitalna mapa groblja (Firebase)</title>
  <style>
    :root{
      --bg:#f3f4f6;
      --card:#fff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --primary:#2563eb;
      --danger:#dc2626;
      --ok:#059669;
      --shadow: 0 10px 25px rgba(0,0,0,.06);
      --radius: 14px;
      --mapW: 1200; /* px - baza */
      --mapH: 800;  /* px - baza */
    }
    *{ box-sizing:border-box; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    body{ margin:0; padding:14px; background:var(--bg); color:#111827; }
    h1{ margin:0; font-size:20px; }
    .app{ max-width:1400px; margin:0 auto; background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; }
    .top{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:10px; }
    .sub{ color:var(--muted); font-size:12px; margin-top:2px; }
    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; background:#e5e7eb; color:#374151; font-size:12px; }
    .switch{ display:inline-flex; gap:4px; padding:4px; border-radius:999px; background:#e5e7eb; }
    .switch button{
      border:0; border-radius:999px; padding:7px 10px;
      background:transparent; color:#374151; cursor:pointer; font-weight:700; font-size:12px;
    }
    .switch button.active{ background:var(--primary); color:#fff; }
    .layout{ display:grid; grid-template-columns: 1fr 1.35fr; gap:14px; min-height:70vh; }
    @media (max-width: 980px){ .layout{ grid-template-columns:1fr; } }

    .card{ border:1px solid var(--border); border-radius:12px; padding:12px; background:#fff; }
    .title{ font-weight:800; font-size:13px; margin:0 0 8px; }
    label{ font-size:12px; color:#374151; display:block; margin-bottom:4px; }
    input, select{
      width:100%; padding:8px 10px; border-radius:10px; border:1px solid #d1d5db; font-size:13px;
    }
    .row{ display:flex; gap:8px; align-items:end; flex-wrap:wrap; }
    .field{ flex:1; min-width:160px; }
    .btn{
      border:0; border-radius:999px; padding:9px 14px; cursor:pointer;
      background:var(--primary); color:#fff; font-weight:800; font-size:13px;
    }
    .btn.secondary{ background:#6b7280; }
    .btn.danger{ background:var(--danger); }
    .btn.ghost{ background:#fff; color:#111827; border:1px solid #d1d5db; }
    .btn.small{ padding:7px 12px; font-size:12px; }

    .hint{ color:var(--muted); font-size:12px; margin-top:6px; }
    .status{ font-size:12px; margin-top:8px; color:var(--ok); min-height:16px; }
    .status.error{ color:var(--danger); }

    table{ width:100%; border-collapse:collapse; font-size:13px; }
    th, td{ text-align:left; padding:8px 8px; border-bottom:1px solid var(--border); }
    th{ background:#f9fafb; position:sticky; top:0; z-index:1; }
    tbody tr{ cursor:pointer; }
    tbody tr:hover{ background:#eff6ff; }
    tbody tr.selected{ background:#dbeafe; }
    .scroll{ max-height: 280px; overflow:auto; border:1px solid var(--border); border-radius:12px; }

    /* MAP */
    .mapWrap{ border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#f9fafb; }
    .mapToolbar{
      display:flex; gap:8px; align-items:center; justify-content:space-between;
      padding:10px 10px; border-bottom:1px solid var(--border);
      background:#fff;
    }
    .mapToolbar .left{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .mapStage{ height: 520px; overflow:auto; position:relative; }
    @media (max-width: 640px){ .mapStage{ height:360px; } }
    .mapInner{
      position:relative;
      width: calc(var(--mapW) * 1px);
      height: calc(var(--mapH) * 1px);
      background-size: 100% 100%;
      background-position: center;
      background-repeat: no-repeat;
      background-image: linear-gradient(45deg,#eef2ff,#f8fafc);
    }
    .gridOverlay{
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(to right, rgba(229,231,235,.85) 0, rgba(229,231,235,.85) 1px, transparent 1px, transparent calc(100%/12)),
        repeating-linear-gradient(to bottom, rgba(229,231,235,.85) 0, rgba(229,231,235,.85) 1px, transparent 1px, transparent calc(100%/12));
      pointer-events:none;
      opacity:.55;
    }
    .marker{
      position:absolute;
      width:14px; height:14px;
      border-radius:50%;
      background:var(--danger);
      border:2px solid #fff;
      transform: translate(-50%,-50%);
      box-shadow: 0 0 0 3px rgba(220,38,38,.25);
      pointer-events:none;
    }
    .marker.secondary{
      background:#111827;
      box-shadow: 0 0 0 3px rgba(17,24,39,.18);
    }
    .crosshair{
      position:absolute; width:18px; height:18px;
      border:2px solid var(--primary);
      border-radius:4px;
      transform: translate(-50%,-50%);
      pointer-events:none;
      box-shadow: 0 0 0 3px rgba(37,99,235,.16);
      background: rgba(255,255,255,.45);
      display:none;
    }
    .twoCols{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 720px){ .twoCols{ grid-template-columns:1fr; } }
    .adminOnly{ display:none; }
    .mutedSmall{ color:var(--muted); font-size:12px; }
    .warn{ background:#fff7ed; border:1px solid #fed7aa; color:#7c2d12; padding:10px; border-radius:12px; font-size:12px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div>
        <h1>Digitalna mapa groblja <span class="pill">Firebase</span></h1>
        <div class="sub">Korisnici pretražuju — administratori (uz prijavu) dodaju/uređuju podatke i mapu.</div>
      </div>

      <div class="switch" title="Režim prikaza">
        <button id="userModeBtn" class="active" type="button">Korisnički</button>
        <button id="adminModeBtn" type="button" disabled>Admin</button>
      </div>
    </div>

    <div id="setupWarning" class="warn" style="display:none;"></div>

    <div class="layout">
      <!-- LEFT -->
      <div class="card">
        <div class="title">Pretraga</div>

        <div class="row">
          <div class="field">
            <label for="qName">Ime i prezime</label>
            <input id="qName" type="text" placeholder="npr. Meho Hadžić" />
          </div>
          <div class="field">
            <label for="qFrom">Datum smrti od</label>
            <input id="qFrom" type="date" />
          </div>
          <div class="field">
            <label for="qTo">Datum smrti do</label>
            <input id="qTo" type="date" />
          </div>
          <div>
            <button class="btn" id="searchBtn" type="button">Pretraži</button>
          </div>
        </div>
        <div class="hint" id="summary"></div>

        <div class="scroll" style="margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th>Ime</th>
                <th>Godine</th>
                <th>Parcela / red / grob</th>
                <th id="thActions" class="adminOnly">Akcije</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>

        <div style="margin-top:12px;" class="adminOnly" id="adminPanel">
          <div class="title">Administracija</div>

          <div id="authBox">
            <div class="twoCols">
              <div>
                <label>Email</label>
                <input id="adminEmail" type="email" placeholder="admin@..." />
              </div>
              <div>
                <label>Lozinka</label>
                <input id="adminPass" type="password" placeholder="••••••••" />
              </div>
            </div>
            <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;">
              <button class="btn small" id="loginBtn" type="button">Prijavi se</button>
              <button class="btn ghost small" id="logoutBtn" type="button" style="display:none;">Odjavi se</button>
              <span class="mutedSmall" id="authState">Niste prijavljeni.</span>
            </div>
            <div class="status" id="authStatus"></div>
          </div>

          <hr style="border:0;border-top:1px solid var(--border); margin:12px 0;">

          <div class="mutedSmall">Klik na mapu desno postavlja lokaciju groba (X/Y). Zatim “Spasi”.</div>

          <div class="twoCols" style="margin-top:10px;">
            <div>
              <label>Ime</label>
              <input id="fFirst" />
            </div>
            <div>
              <label>Prezime</label>
              <input id="fLast" />
            </div>
            <div>
              <label>Datum rođenja</label>
              <input id="fDob" type="date" />
            </div>
            <div>
              <label>Datum smrti</label>
              <input id="fDod" type="date" />
            </div>
            <div>
              <label>Parcela / blok</label>
              <input id="fSection" placeholder="npr. A" />
            </div>
            <div>
              <label>Red</label>
              <input id="fRow" type="number" min="1" />
            </div>
            <div>
              <label>Broj groba</label>
              <input id="fPlot" type="number" min="1" />
            </div>
            <div>
              <label>Lokacija (X%, Y%)</label>
              <input id="fXY" placeholder="kliknite na mapu…" disabled />
            </div>
          </div>

          <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;">
            <button class="btn small" id="saveBtn" type="button">Spasi</button>
            <button class="btn secondary small" id="cancelBtn" type="button" style="display:none;">Otkaži uređivanje</button>
            <button class="btn ghost small" id="importBtn" type="button" title="Uvezi stare podatke iz localStorage">Import localStorage → Firebase</button>
          </div>
          <div class="status" id="formStatus"></div>

          <div style="margin-top:12px;">
            <div class="title">Mapa (pozadina)</div>
            <div class="twoCols">
              <div>
                <label>Učitaj novu sliku</label>
                <input id="mapFile" type="file" accept="image/*" />
              </div>
              <div style="display:flex; gap:8px; align-items:end; flex-wrap:wrap;">
                <button class="btn small" id="uploadMapBtn" type="button">Upload mape</button>
                <button class="btn danger small" id="clearMapBtn" type="button">Obriši mapu</button>
              </div>
            </div>
            <div class="hint">Slika se čuva u Firebase Storage, a URL u Firestore (<span class="pill">settings/map</span>).</div>
            <div class="status" id="mapStatus"></div>
          </div>
        </div>

      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="title">Mapa mezarja</div>

        <div class="mapWrap">
          <div class="mapToolbar">
            <div class="left">
              <span class="mutedSmall">Zum:</span>
              <button class="btn ghost small" id="zoomOutBtn" type="button">−</button>
              <button class="btn ghost small" id="zoomInBtn" type="button">+</button>
              <button class="btn ghost small" id="fitBtn" type="button">Fit</button>
              <span class="mutedSmall" id="mapLabel">Nema mape (admin može upload)</span>
            </div>
            <div class="mutedSmall" id="pickHint" style="display:none;">Admin: kliknite na mapu za lokaciju</div>
          </div>

          <div class="mapStage" id="mapStage">
            <div class="mapInner" id="mapInner" title="Klik na mapu postavlja lokaciju (samo admin)">
              <div class="gridOverlay"></div>
              <div class="crosshair" id="crosshair"></div>
              <!-- markers are injected -->
            </div>
          </div>
        </div>

        <div class="hint" style="margin-top:10px;">
          Savjet: za precizniji unos lokacija, prvo zumirajte mapu, pa kliknite.
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    /*
      ✅ Firebase CDN (browser modules) – pattern iz zvanične Firebase dokumentacije. 
      Primjer verzije 12.7.0: https://www.gstatic.com/firebasejs/12.7.0/firebase-<service>.js
      (vidi “Alternative ways to add Firebase…”) 
    */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc, getDoc, onSnapshot, query, orderBy, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-storage.js";

    // =========================
    // 1) UBACI SVOJ FIREBASE CONFIG
    // =========================
    const firebaseConfig = {
      apiKey: "PASTE_HERE",
      authDomain: "PASTE_HERE",
      projectId: "PASTE_HERE",
      storageBucket: "PASTE_HERE",
      messagingSenderId: "PASTE_HERE",
      appId: "PASTE_HERE",
    };

    const setupWarning = document.getElementById("setupWarning");
    const looksUnconfigured = Object.values(firebaseConfig).some(v => String(v).includes("PASTE_HERE"));
    if (looksUnconfigured){
      setupWarning.style.display = "block";
      setupWarning.innerHTML = `
        <b>Firebase nije podešen.</b><br>
        Otvorite fajl i u <code>firebaseConfig</code> zalijepite podatke iz Firebase Console (Project settings → Your apps → Web app).<br>
        Dok to ne uradite, aplikacija neće učitavati podatke.
      `;
      // Do not return; allow UI to render, but Firebase init will fail.
    }

    // =========================
    // State
    // =========================
    let MODE = "user"; // user | admin
    let all = [];      // all graves (from Firestore)
    let filtered = [];
    let selectedId = null;
    let editingId = null;
    let pickedXY = null; // {x, y} in percent
    let mapUrl = null;
    let mapScale = 1;

    // =========================
    // DOM
    // =========================
    const userModeBtn = document.getElementById("userModeBtn");
    const adminModeBtn = document.getElementById("adminModeBtn");

    const qName = document.getElementById("qName");
    const qFrom = document.getElementById("qFrom");
    const qTo = document.getElementById("qTo");
    const searchBtn = document.getElementById("searchBtn");
    const summary = document.getElementById("summary");
    const rowsEl = document.getElementById("rows");
    const thActions = document.getElementById("thActions");

    const adminPanel = document.getElementById("adminPanel");
    const authStateEl = document.getElementById("authState");
    const authStatus = document.getElementById("authStatus");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const adminEmail = document.getElementById("adminEmail");
    const adminPass = document.getElementById("adminPass");

    const fFirst = document.getElementById("fFirst");
    const fLast = document.getElementById("fLast");
    const fDob = document.getElementById("fDob");
    const fDod = document.getElementById("fDod");
    const fSection = document.getElementById("fSection");
    const fRow = document.getElementById("fRow");
    const fPlot = document.getElementById("fPlot");
    const fXY = document.getElementById("fXY");
    const saveBtn = document.getElementById("saveBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const formStatus = document.getElementById("formStatus");

    const importBtn = document.getElementById("importBtn");

    const mapStage = document.getElementById("mapStage");
    const mapInner = document.getElementById("mapInner");
    const mapLabel = document.getElementById("mapLabel");
    const pickHint = document.getElementById("pickHint");
    const crosshair = document.getElementById("crosshair");

    const zoomOutBtn = document.getElementById("zoomOutBtn");
    const zoomInBtn = document.getElementById("zoomInBtn");
    const fitBtn = document.getElementById("fitBtn");

    const mapFile = document.getElementById("mapFile");
    const uploadMapBtn = document.getElementById("uploadMapBtn");
    const clearMapBtn = document.getElementById("clearMapBtn");
    const mapStatus = document.getElementById("mapStatus");

    // =========================
    // Helpers
    // =========================
    const pad2 = n => String(n).padStart(2,"0");

    function safeText(s){ return (s ?? "").toString(); }

    function fullName(p){
      return `${safeText(p.firstName)} ${safeText(p.lastName)}`.trim();
    }

    function yearsStr(p){
      const y1 = p.dateOfBirth ? String(p.dateOfBirth).slice(0,4) : "";
      const y2 = p.dateOfDeath ? String(p.dateOfDeath).slice(0,4) : "";
      if (y1 && y2) return `${y1}–${y2}`;
      if (y1) return `${y1}–`;
      if (y2) return `–${y2}`;
      return "";
    }

    function placeStr(p){
      const s = safeText(p.section);
      const r = (p.row ?? "") !== "" ? `R${p.row}` : "";
      const g = (p.plotNumber ?? "") !== "" ? `G${p.plotNumber}` : "";
      return [s, r, g].filter(Boolean).join(" / ");
    }

    function setStatus(el, msg="", isErr=false){
      el.textContent = msg;
      el.classList.toggle("error", !!isErr);
      if (!msg) el.classList.remove("error");
    }

    function isAdminMode(){ return MODE === "admin"; }

    function setMode(next){
      MODE = next;
      userModeBtn.classList.toggle("active", MODE === "user");
      adminModeBtn.classList.toggle("active", MODE === "admin");
      // admin bits:
      document.querySelectorAll(".adminOnly").forEach(el => {
        el.style.display = (MODE === "admin") ? "" : "none";
      });
      pickHint.style.display = (MODE === "admin") ? "" : "none";
      renderTable();
      renderMarkers();
    }

    function applyMapScale(){
      mapInner.style.width  = `calc(var(--mapW) * ${mapScale} * 1px)`;
      mapInner.style.height = `calc(var(--mapH) * ${mapScale} * 1px)`;
      renderMarkers();
      if (pickedXY) renderCrosshair();
    }

    function fitMap(){
      mapScale = 1;
      applyMapScale();
      mapStage.scrollLeft = 0;
      mapStage.scrollTop = 0;
    }

    function setMapBackground(url){
      mapUrl = url || null;
      if (mapUrl){
        mapInner.style.backgroundImage = `url("${mapUrl}")`;
        mapLabel.textContent = "Mapa učitana";
      } else {
        mapInner.style.backgroundImage = `linear-gradient(45deg,#eef2ff,#f8fafc)`;
        mapLabel.textContent = "Nema mape (admin može upload)";
      }
    }

    function scrollToMarker(xPct, yPct){
      // center marker in viewport if possible
      const w = mapInner.getBoundingClientRect().width;
      const h = mapInner.getBoundingClientRect().height;
      const x = (xPct/100) * w;
      const y = (yPct/100) * h;
      const cx = Math.max(0, x - mapStage.clientWidth/2);
      const cy = Math.max(0, y - mapStage.clientHeight/2);
      mapStage.scrollLeft = cx;
      mapStage.scrollTop = cy;
    }

    function renderCrosshair(){
      if (!pickedXY){ crosshair.style.display="none"; return; }
      crosshair.style.display = "";
      crosshair.style.left = `${pickedXY.x}%`;
      crosshair.style.top  = `${pickedXY.y}%`;
    }

    function clearForm(){
      editingId = null;
      pickedXY = null;
      fFirst.value = "";
      fLast.value = "";
      fDob.value = "";
      fDod.value = "";
      fSection.value = "";
      fRow.value = "";
      fPlot.value = "";
      fXY.value = "";
      cancelBtn.style.display = "none";
      renderCrosshair();
      setStatus(formStatus, "");
    }

    function fillForm(p){
      editingId = p.id;
      pickedXY = { x: Number(p.mapX ?? 0), y: Number(p.mapY ?? 0) };
      fFirst.value = safeText(p.firstName);
      fLast.value = safeText(p.lastName);
      fDob.value = safeText(p.dateOfBirth);
      fDod.value = safeText(p.dateOfDeath);
      fSection.value = safeText(p.section);
      fRow.value = (p.row ?? "") === null ? "" : safeText(p.row);
      fPlot.value = (p.plotNumber ?? "") === null ? "" : safeText(p.plotNumber);
      fXY.value = `${pickedXY.x.toFixed(2)}%, ${pickedXY.y.toFixed(2)}%`;
      cancelBtn.style.display = "";
      renderCrosshair();
    }

    function matchesFilters(p){
      const name = safeText(qName.value).trim().toLowerCase();
      const from = safeText(qFrom.value);
      const to = safeText(qTo.value);

      let ok = true;
      if (name){
        const fn = fullName(p).toLowerCase();
        ok = ok && fn.includes(name);
      }
      if (from){
        ok = ok && safeText(p.dateOfDeath) >= from;
      }
      if (to){
        ok = ok && safeText(p.dateOfDeath) <= to;
      }
      return ok;
    }

    function applyFilters(){
      filtered = all.filter(matchesFilters);
      summary.textContent = `Prikazano: ${filtered.length} / ${all.length}`;
      renderTable();
      renderMarkers();
    }

    function renderTable(){
      rowsEl.innerHTML = "";
      const showActions = (MODE === "admin");
      thActions.style.display = showActions ? "" : "none";

      const list = filtered.length ? filtered : all;

      for (const p of list){
        const tr = document.createElement("tr");
        tr.classList.toggle("selected", p.id === selectedId);
        tr.innerHTML = `
          <td>${fullName(p)}</td>
          <td>${yearsStr(p)}</td>
          <td>${placeStr(p)}</td>
          ${showActions ? `<td>
              <button class="btn ghost small" data-act="edit">Uredi</button>
              <button class="btn danger small" data-act="del">Obriši</button>
          </td>` : ""}
        `;

        tr.addEventListener("click", (e) => {
          const btn = e.target?.closest("button");
          if (btn && showActions){
            const act = btn.dataset.act;
            if (act === "edit"){
              e.stopPropagation();
              selectPerson(p.id);
              fillForm(p);
              scrollToMarker(Number(p.mapX||0), Number(p.mapY||0));
              return;
            }
            if (act === "del"){
              e.stopPropagation();
              onDelete(p);
              return;
            }
          }
          selectPerson(p.id);
          scrollToMarker(Number(p.mapX||0), Number(p.mapY||0));
        });

        rowsEl.appendChild(tr);
      }
    }

    function renderMarkers(){
      // remove existing markers (but keep overlay + crosshair)
      [...mapInner.querySelectorAll(".marker")].forEach(m => m.remove());

      const list = filtered.length ? filtered : all;
      for (const p of list){
        if (p.mapX == null || p.mapY == null) continue;
        const m = document.createElement("div");
        m.className = "marker" + (p.id === selectedId ? " secondary" : "");
        m.style.left = `${Number(p.mapX)}%`;
        m.style.top  = `${Number(p.mapY)}%`;
        mapInner.appendChild(m);
      }
    }

    function selectPerson(id){
      selectedId = id;
      renderTable();
      renderMarkers();
    }

    // =========================
    // Firebase init
    // =========================
    let app, db, auth, storage;
    try{
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      storage = getStorage(app);
    } catch (e){
      console.warn("Firebase init failed:", e);
    }

    // =========================
    // Firestore listeners
    // =========================
    let unsubscribeGraves = null;

    function startListeners(){
      if (!db) return;

      // Graves
      const q = query(collection(db, "graves"), orderBy("lastNameLower"));
      unsubscribeGraves = onSnapshot(q, (snap) => {
        const next = [];
        snap.forEach(docSnap => {
          next.push({ id: docSnap.id, ...docSnap.data() });
        });
        all = next;
        // keep selection if exists
        if (selectedId && !all.some(p => p.id === selectedId)) selectedId = null;
        applyFilters();
      }, (err) => {
        console.error(err);
        summary.textContent = "Greška pri čitanju podataka (provjerite Firestore pravila / indeks).";
      });

      // Map settings
      const mapDocRef = doc(db, "settings", "map");
      onSnapshot(mapDocRef, (snap) => {
        if (snap.exists()){
          const d = snap.data();
          setMapBackground(d.url || null);
        } else {
          setMapBackground(null);
        }
      });
    }

    // =========================
    // Auth
    // =========================
    let isAuthed = false;

    function updateAdminUI(){
      // Admin button enabled only if logged in
      adminModeBtn.disabled = !isAuthed;
      if (!isAuthed && MODE === "admin") setMode("user");

      // auth box buttons
      loginBtn.style.display = isAuthed ? "none" : "";
      logoutBtn.style.display = isAuthed ? "" : "none";
      authStateEl.textContent = isAuthed ? "Prijavljeni ste." : "Niste prijavljeni.";
    }

    if (auth){
      onAuthStateChanged(auth, (user) => {
        isAuthed = !!user;
        updateAdminUI();
      });
    }

    loginBtn?.addEventListener("click", async () => {
      setStatus(authStatus, "");
      try{
        if (!auth) throw new Error("Auth nije inicijaliziran.");
        const email = adminEmail.value.trim();
        const pass = adminPass.value;
        if (!email || !pass) throw new Error("Unesite email i lozinku.");
        await signInWithEmailAndPassword(auth, email, pass);
        setStatus(authStatus, "Prijava uspješna.");
      } catch (e){
        setStatus(authStatus, e?.message || "Greška pri prijavi.", true);
      }
    });

    logoutBtn?.addEventListener("click", async () => {
      setStatus(authStatus, "");
      try{
        if (!auth) throw new Error("Auth nije inicijaliziran.");
        await signOut(auth);
        setStatus(authStatus, "Odjavljeni ste.");
      } catch (e){
        setStatus(authStatus, e?.message || "Greška pri odjavi.", true);
      }
    });

    // =========================
    // CRUD
    // =========================
    async function savePerson(){
      setStatus(formStatus, "");
      try{
        if (!isAuthed) throw new Error("Morate biti prijavljeni kao admin.");
        if (!db) throw new Error("Firestore nije inicijaliziran.");

        const firstName = fFirst.value.trim();
        const lastName  = fLast.value.trim();
        if (!firstName || !lastName) throw new Error("Ime i prezime su obavezni.");
        if (!pickedXY) throw new Error("Kliknite na mapu da postavite lokaciju (X/Y).");

        const payload = {
          firstName,
          lastName,
          firstNameLower: firstName.toLowerCase(),
          lastNameLower: lastName.toLowerCase(),
          fullNameLower: `${firstName} ${lastName}`.toLowerCase(),
          dateOfBirth: fDob.value || "",
          dateOfDeath: fDod.value || "",
          section: fSection.value.trim(),
          row: fRow.value ? Number(fRow.value) : null,
          plotNumber: fPlot.value ? Number(fPlot.value) : null,
          mapX: Number(pickedXY.x.toFixed(4)),
          mapY: Number(pickedXY.y.toFixed(4)),
          updatedAt: serverTimestamp(),
        };

        if (!editingId){
          payload.createdAt = serverTimestamp();
          await addDoc(collection(db, "graves"), payload);
          setStatus(formStatus, "Zapis spašen.");
          clearForm();
        } else {
          await updateDoc(doc(db, "graves", editingId), payload);
          setStatus(formStatus, "Zapis ažuriran.");
          // keep edit mode
        }
      } catch (e){
        setStatus(formStatus, e?.message || "Greška pri spremanju.", true);
      }
    }

    async function onDelete(p){
      try{
        if (!isAuthed) throw new Error("Morate biti prijavljeni kao admin.");
        if (!db) throw new Error("Firestore nije inicijaliziran.");
        if (!confirm(`Obrisati zapis: ${fullName(p)}?`)) return;
        await deleteDoc(doc(db, "graves", p.id));
        if (editingId === p.id) clearForm();
      } catch (e){
        alert(e?.message || "Greška pri brisanju.");
      }
    }

    // =========================
    // Map click (pick XY)
    // =========================
    mapInner.addEventListener("click", (e) => {
      if (!(MODE === "admin" && isAuthed)) return;

      const rect = mapInner.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width) * 100;
      const y = ((e.clientY - rect.top) / rect.height) * 100;

      const clamped = (v) => Math.max(0, Math.min(100, v));
      pickedXY = { x: clamped(x), y: clamped(y) };
      fXY.value = `${pickedXY.x.toFixed(2)}%, ${pickedXY.y.toFixed(2)}%`;
      renderCrosshair();
    });

    // =========================
    // Map upload / clear
    // =========================
    async function uploadMap(){
      setStatus(mapStatus, "");
      try{
        if (!isAuthed) throw new Error("Morate biti prijavljeni kao admin.");
        if (!storage || !db) throw new Error("Firebase nije inicijaliziran.");
        const file = mapFile.files?.[0];
        if (!file) throw new Error("Odaberite sliku.");
        // store at map/current.<ext>
        const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
        const path = `map/current.${ext}`;
        const objRef = sRef(storage, path);
        await uploadBytes(objRef, file, { contentType: file.type || "image/jpeg" });
        const url = await getDownloadURL(objRef);

        await setDoc(doc(db, "settings", "map"), {
          url,
          path,
          updatedAt: serverTimestamp(),
        }, { merge: true });

        setStatus(mapStatus, "Mapa uploadovana.");
      } catch (e){
        setStatus(mapStatus, e?.message || "Greška pri uploadu mape.", true);
      }
    }

    async function clearMap(){
      setStatus(mapStatus, "");
      try{
        if (!isAuthed) throw new Error("Morate biti prijavljeni kao admin.");
        if (!storage || !db) throw new Error("Firebase nije inicijaliziran.");

        const snap = await getDoc(doc(db, "settings", "map"));
        if (snap.exists()){
          const d = snap.data();
          if (d.path){
            try{
              await deleteObject(sRef(storage, d.path));
            } catch (e) {
              // ignore (maybe already deleted)
            }
          }
          await setDoc(doc(db, "settings", "map"), { url: "", path: "", updatedAt: serverTimestamp() }, { merge:true });
        }
        setStatus(mapStatus, "Mapa obrisana.");
      } catch (e){
        setStatus(mapStatus, e?.message || "Greška pri brisanju mape.", true);
      }
    }

    // =========================
    // Import from localStorage (stara verzija)
    // =========================
    const LEGACY_KEY = "grobljeZapisi_v1";
    const LEGACY_MAP_KEY = "grobljeZapisi_v1_mapImage";

    function dataURLtoBlob(dataUrl){
      const [meta, b64] = dataUrl.split(",");
      const mime = /data:([^;]+)/.exec(meta)?.[1] || "image/png";
      const bin = atob(b64);
      const u8 = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i);
      return new Blob([u8], { type: mime });
    }

    async function importLegacy(){
      setStatus(formStatus, "");
      try{
        if (!isAuthed) throw new Error("Morate biti prijavljeni kao admin.");
        if (!db) throw new Error("Firestore nije inicijaliziran.");

        const raw = localStorage.getItem(LEGACY_KEY);
        if (!raw) throw new Error(`Nema podataka u localStorage (${LEGACY_KEY}).`);
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr) || arr.length === 0) throw new Error("Prazna lista.");

        // Batch write (500 per batch)
        let batch = writeBatch(db);
        let opCount = 0;
        let total = 0;

        for (const p of arr){
          const firstName = safeText(p.firstName).trim();
          const lastName  = safeText(p.lastName).trim();
          if (!firstName && !lastName) continue;

          const payload = {
            firstName,
            lastName,
            firstNameLower: firstName.toLowerCase(),
            lastNameLower: lastName.toLowerCase(),
            fullNameLower: `${firstName} ${lastName}`.toLowerCase(),
            dateOfBirth: safeText(p.dateOfBirth),
            dateOfDeath: safeText(p.dateOfDeath),
            section: safeText(p.section),
            row: (p.row ?? "") === "" ? null : Number(p.row),
            plotNumber: (p.plotNumber ?? "") === "" ? null : Number(p.plotNumber),
            mapX: Number(p.mapX ?? 0),
            mapY: Number(p.mapY ?? 0),
            legacyId: p.id ?? null,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
          };

          const ref = doc(collection(db, "graves"));
          batch.set(ref, payload);
          opCount++;
          total++;

          if (opCount >= 450){
            await batch.commit();
            batch = writeBatch(db);
            opCount = 0;
          }
        }

        if (opCount > 0) await batch.commit();

        // map import (optional)
        const legacyMap = localStorage.getItem(LEGACY_MAP_KEY);
        if (legacyMap && storage){
          try{
            const blob = dataURLtoBlob(legacyMap);
            const objRef = sRef(storage, "map/legacy_import.png");
            await uploadBytes(objRef, blob, { contentType: blob.type });
            const url = await getDownloadURL(objRef);
            await setDoc(doc(db, "settings", "map"), { url, path: "map/legacy_import.png", updatedAt: serverTimestamp() }, { merge:true });
          } catch(e){
            console.warn("Map import failed:", e);
          }
        }

        setStatus(formStatus, `Import završio: ${total} zapisa.`);
      } catch (e){
        setStatus(formStatus, e?.message || "Greška pri importu.", true);
      }
    }

    // =========================
    // Events
    // =========================
    userModeBtn.addEventListener("click", () => setMode("user"));
    adminModeBtn.addEventListener("click", () => setMode("admin"));

    searchBtn.addEventListener("click", applyFilters);
    qName.addEventListener("keydown", (e) => { if (e.key === "Enter") applyFilters(); });
    qFrom.addEventListener("change", applyFilters);
    qTo.addEventListener("change", applyFilters);

    saveBtn.addEventListener("click", savePerson);
    cancelBtn.addEventListener("click", clearForm);

    importBtn.addEventListener("click", () => {
      if (confirm("Import će dodati zapise iz localStorage u Firestore. Nastaviti?")){
        importLegacy();
      }
    });

    zoomOutBtn.addEventListener("click", () => {
      mapScale = Math.max(0.6, Math.round((mapScale - 0.2) * 10)/10);
      applyMapScale();
    });
    zoomInBtn.addEventListener("click", () => {
      mapScale = Math.min(3.0, Math.round((mapScale + 0.2) * 10)/10);
      applyMapScale();
    });
    fitBtn.addEventListener("click", fitMap);

    uploadMapBtn.addEventListener("click", uploadMap);
    clearMapBtn.addEventListener("click", clearMap);

    // =========================
    // Start
    // =========================
    setMode("user");
    fitMap();

    if (!looksUnconfigured) startListeners();
  </script>
</body>
</html>
